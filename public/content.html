<!doctype html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>תוכן - BurekaFlix</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="/css/main.css">
  </head>
  <body>
    <!-- Header -->
    <header class="app-header">
      <div class="container d-flex align-items-center justify-content-between py-3">
        <a class="brand" href="/" aria-label="דף הבית">
          <img src="/logo.png" alt="BurekaFlix" class="brand-logo" />
          <span class="brand-title">בורקפליקס</span>
        </a>
        <nav class="d-flex align-items-center gap-3">
          <a href="/catalog" class="link-light text-decoration-none">חזור לקטלוג</a>
        </nav>
      </div>
    </header>

    <!-- Main -->
    <main class="container my-4">
      <section class="content-card bg-white rounded shadow-sm p-3 p-md-4 mx-auto">
        <!-- Skeleton/loading -->
        <div id="loading" class="d-flex align-items-center gap-2">
          <div class="spinner-border" role="status" aria-hidden="true"></div>
          <span>טוען תוכן…</span>
        </div>

        <!-- Content will be injected here -->
        <div id="contentArea" hidden></div>

        <!-- Error placeholder -->
        <div id="error" class="alert alert-danger d-none" role="alert">
          אירעה שגיאה בטעינת הדף. נסו לרענן או לחזור מאוחר יותר.
        </div>
      </section>
    </main>

    <!-- Scripts -->
    <script>
      /** Utils **/
      const $ = (sel) => document.querySelector(sel);

      function getContentIdFromPath() {
        const parts = window.location.pathname.split("/").filter(Boolean);
        return parts[parts.length - 1] || "";
      }

      // Simple HTML escape for plain text insertions
      function escapeHtml(str = "") {
        return String(str)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function show(el) { el.hidden = false; el.classList.remove("d-none"); }
      function hide(el) { el.hidden = true; el.classList.add("d-none"); }

      /** Rendering **/
      function renderContent(c) {
        const genres = Array.isArray(c.genres) ? c.genres.join(", ") : "";
        const poster = c.posterUrl || "https://via.placeholder.com/320x460?text=Poster";

        return `
          <div class="row g-4 align-items-start">
            <div class="col-12 col-md-auto">
              <img class="poster" src="${escapeHtml(poster)}" alt="פוסטר: ${escapeHtml(c.title || "ללא שם")}" />
            </div>

            <div class="col">
              <h1 class="h3 mb-2">${escapeHtml(c.title || "ללא כותרת")}</h1>
              <p class="muted mb-3">
                ${escapeHtml(c.year ?? "")}${c.year && genres ? " • " : ""}${escapeHtml(genres)}
              </p>
              <p class="mb-4">${escapeHtml(c.summary || "")}</p>

              <div class="d-flex gap-2">
                <button id="likeBtn" class="btn btn-outline-primary" type="button" aria-label="אהבתי">
                  אהבתי
                </button>
              </div>
            </div>
          </div>
        `;
      }

      /** Data **/
      async function fetchWithTimeout(resource, options = {}) {
        const { timeout = 10000, ...rest } = options;
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), timeout);
        try {
          const resp = await fetch(resource, { ...rest, signal: controller.signal });
          return resp;
        } finally {
          clearTimeout(id);
        }
      }

      async function load() {
        const id = getContentIdFromPath();
        const contentArea = $("#contentArea");
        const loading = $("#loading");
        const errorBox = $("#error");

        hide(contentArea);
        hide(errorBox);
        show(loading);

        try {
          const res = await fetchWithTimeout("/api/content/" + encodeURIComponent(id), { timeout: 12000 });
          if (!res.ok) throw new Error("Content fetch failed: " + res.status);
          const c = await res.json();

          contentArea.innerHTML = renderContent(c);
          hide(loading);
          show(contentArea);

          // Like handler
          const likeBtn = $("#likeBtn");
          if (likeBtn) {
            likeBtn.addEventListener("click", async () => {
              likeBtn.disabled = true;
              try {
                const r = await fetch("/content/" + encodeURIComponent(id) + "/like", { method: "POST" });
                if (r.ok) {
                  // Toast-like feedback with Bootstrap classes
                  likeBtn.classList.remove("btn-outline-primary");
                  likeBtn.classList.add("btn-success");
                  likeBtn.textContent = "נשמר ✔";
                } else {
                  alert("שגיאה בשמירת הלייק");
                }
              } catch {
                alert("שגיאה בשמירת הלייק");
              } finally {
                setTimeout(() => { likeBtn.disabled = false; }, 800);
              }
            });
          }
        } catch (e) {
          hide(loading);
          errorBox.textContent = "שגיאה בטעינת הדף. " + (e?.message || "");
          errorBox.classList.remove("d-none");
        }
      }

      document.addEventListener("DOMContentLoaded", load);
    </script>
  </body>
</html>
