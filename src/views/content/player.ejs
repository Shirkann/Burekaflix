<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>נגן תוכן - BurekaFlix</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>
    <main class="container-fluid position-relative p-0">
        <video id="contentPlayer" class="w-100" preload="metadata"></video>
        <div class="player-controls">
            <button id="playPauseBtn" class="btn btn-primary">נגן</button>
            <button id="rewindBtn" class="btn btn-secondary">⏩ 10 שניות</button>
            <button id="forwardBtn" class="btn btn-secondary">10 שניות ⏪</button>
            <button id="fullscreenBtn" class="btn btn-secondary">מסך מלא</button>
            <button id="episodesToggleBtn" class="btn btn-outline-info">רשימת פרקים</button>
            <button id="nextEpisodeBtn" class="btn btn-success">פרק הבא ▶</button>
            <button id="backBtn" class="btn btn-outline-light">← חזרה</button>
        </div>
        <div class="timeline"><div class="timeline-progress"></div></div>
                <aside id="episodeDrawer" class="position-absolute bottom-0 end-0 bg-dark text-white p-3 d-none" style="width:300px;max-height:100%;overflow-y:auto;">
          <h6 class="border-bottom pb-2">פרקים</h6>
          <ul id="episodesList" class="list-unstyled mb-0"></ul>
        </aside>
    </main>

    <script>
                function getId(){
                    const parts=window.location.pathname.split('/').filter(Boolean);
                    return parts[parts.length-2]; // /content/:id/player
                }

                const player = document.getElementById('contentPlayer');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const rewindBtn = document.getElementById('rewindBtn');
        const forwardBtn = document.getElementById('forwardBtn');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
                const episodesToggleBtn = document.getElementById('episodesToggleBtn');
                const nextEpisodeBtn = document.getElementById('nextEpisodeBtn');
                const backBtn = document.getElementById('backBtn');
                const timeline = document.querySelector('.timeline');
                const timelineProgress = document.querySelector('.timeline-progress');
                const episodeDrawer = document.getElementById('episodeDrawer');
                const episodesList = document.getElementById('episodesList');
                let contentData=null;

                async function loadContent(){
                    try{
                        const id=getId();
                        const resp=await fetch('/api/content/'+encodeURIComponent(id));
                        if(!resp.ok) throw new Error('שגיאה בטעינת התוכן');
                        contentData=await resp.json();
                                                // סרט? הסתרת פרקים והצבת videoUrl בודד
                                                if((contentData.type||'').toLowerCase()==='movie'){
                            episodesToggleBtn.classList.add('d-none');
                            nextEpisodeBtn.classList.add('d-none');
                                                        if(!contentData.videoUrl){throw new Error('לא נמצא קובץ וידאו');}
                                                        player.src='/videos/'+encodeURIComponent(contentData.videoUrl);
                        } else {
                                                        // סדרה: שימוש במערך episodes של שמות קבצים
                                                        if(Array.isArray(contentData.episodes) && contentData.episodes.length){
                                                            buildEpisodes(contentData.episodes);
                                                            player.src='/videos/'+encodeURIComponent(contentData.episodes[0]);
                                                        } else {
                                                            throw new Error('לא נמצאו פרקים');
                                                        }
                        }
                        player.play().catch(()=>{});
                        playPauseBtn.textContent='השהה';
                    }catch(e){console.error(e);alert(e.message);}
                }

                        function buildEpisodes(list){
                            episodesList.innerHTML='';
                            if(!Array.isArray(list)||!list.length){episodesList.innerHTML='<li class="text-muted">אין פרקים</li>';return;}
                            list.forEach((fileName,i)=>{
                                // fileName is the episode video file name (string)
                                const li=document.createElement('li');
                                li.className='mb-1';
                                li.innerHTML='<button class="btn btn-sm btn-outline-light w-100 text-start" data-index="'+i+'">פרק '+(i+1)+'</button>';
                                episodesList.appendChild(li);
                            });
                            highlightCurrentEpisode();
                        }

                        function highlightCurrentEpisode(){
                            if(!contentData||!Array.isArray(contentData.episodes)) return;
                            const currentIndex = contentData.episodes.findIndex(fn=> player.src.includes(encodeURIComponent(fn)) || player.src.endsWith(fn));
                            [...episodesList.querySelectorAll('button[data-index]')].forEach(btn=>{
                                if(Number(btn.dataset.index)===currentIndex){
                                    btn.classList.remove('btn-outline-light');
                                    btn.classList.add('btn-primary');
                                } else {
                                    btn.classList.remove('btn-primary');
                                    btn.classList.add('btn-outline-light');
                                }
                            });
                        }

        playPauseBtn.addEventListener('click', () => {
            if (player.paused) {
                player.play();
                playPauseBtn.textContent = 'השהה';
            } else {
                player.pause();
                playPauseBtn.textContent = 'נגן';
            }
        });

        rewindBtn.addEventListener('click', () => {
            player.currentTime = Math.max(0, player.currentTime - 10);
        });

        forwardBtn.addEventListener('click', () => {
            player.currentTime = Math.min(player.duration, player.currentTime + 10);
        });

        fullscreenBtn.addEventListener('click', () => {
            if (!document.fullscreenElement) {
                player.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        });
                episodesToggleBtn.addEventListener('click',()=>{
                    episodeDrawer.classList.toggle('d-none');
                });
                        episodesList.addEventListener('click',(e)=>{
                            const btn=e.target.closest('button[data-index]');
                            if(!btn||!contentData) return;
                            const idx=Number(btn.dataset.index);
                            const fileName=contentData.episodes[idx];
                            if(fileName){
                                player.src='/videos/'+encodeURIComponent(fileName);
                                player.play();
                                playPauseBtn.textContent='השהה';
                                highlightCurrentEpisode();
                            } else {
                                alert('אין וידאו לפרק הזה');
                            }
                        });
                        nextEpisodeBtn.addEventListener('click',()=>{
                            if(!contentData||!Array.isArray(contentData.episodes)) return alert('אין פרקים');
                            const currentIndex=contentData.episodes.findIndex(fn=> player.src.includes(encodeURIComponent(fn)) || player.src.endsWith(fn));
                            const next=contentData.episodes[currentIndex+1];
                            if(next){
                                player.src='/videos/'+encodeURIComponent(next);
                                player.play();
                                playPauseBtn.textContent='השהה';
                                highlightCurrentEpisode();
                            } else alert('אין פרק נוסף');
                        });
                backBtn.addEventListener('click',()=>{history.back();});

        player.addEventListener('timeupdate', () => {
            const progress = (player.currentTime / player.duration) * 100;
            timelineProgress.style.width = `${progress}%`;
            highlightCurrentEpisode();
        });

        timeline.addEventListener('click', (e) => {
            const rect = timeline.getBoundingClientRect();
            const clickPosition = e.clientX - rect.left;
            const percentage = clickPosition / rect.width;
            player.currentTime = percentage * player.duration;
        });

        loadContent();
    </script>
</body>
</html>