<!doctype html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>תוכן - BurekaFlix</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/css/main.css" />
    <!-- נגן המשולב הוסר. שימוש בדף player.ejs -->
  </head>
  <body>
    <%- include("../partial/header", { activePage: "catalog" }) %>

    <main class="container my-4">
      <section class="content-card bg-white rounded shadow-sm p-3 p-md-4 mx-auto">
        <div id="loading" class="d-flex align-items-center gap-2">
          <div class="spinner-border" role="status" aria-hidden="true"></div>
          <span>טוען תוכן…</span>
        </div>

        <div id="contentArea" hidden></div>

        <div id="error" class="alert alert-danger d-none" role="alert">
          אירעה שגיאה בטעינת הדף. נסו לרענן או לחזור מאוחר יותר.
        </div>
      </section>
    </main>

    <!-- נגן הוסר מהדף הזה -->

    <script>
      const $ = (sel) => document.querySelector(sel);

      function getContentIdFromPath() {
        const parts = window.location.pathname.split("/").filter(Boolean);
        return parts[parts.length - 1] || "";
      }

      function escapeHtml(str = "") {
        return String(str)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function show(el) {
        el.hidden = false;
        el.classList.remove("d-none");
      }
      function hide(el) {
        el.hidden = true;
        el.classList.add("d-none");
      }

      function renderContent(c) {
        const genres = Array.isArray(c.genres) ? c.genres.join(", ") : "";
        const players = Array.isArray(c.players) ? c.players.join(", ") : "";
        const poster = c.posterUrl || "https://via.placeholder.com/320x460?text=Poster";
        const stagemanager = c.stagemanager;
        const liked = c.likedByUser; 
        console.log(c.likedByUser); 
        const imdbRating =
          typeof c.imdb_rating === "number"
            ? c.imdb_rating.toFixed(1)
            : typeof c.rating === "number"
            ? c.rating.toFixed(1)
            : null;

        return `
          <div class="row g-4 align-items-start">
            <div class="col-12 col-md-auto">
              <img
                class="poster"
                src="${escapeHtml(poster)}"
                alt="פוסטר: ${escapeHtml(c.title || "ללא שם")}"
              />
            </div>

            <div class="col">
              <h1 class="h3 mb-2">${escapeHtml(c.title || "ללא כותרת")}</h1>
              <p class="muted mb-3">
                ${escapeHtml(c.year ?? "")}${c.year && genres ? " • " : ""}${escapeHtml(
          genres,
        )}
              </p>
              <p class="muted mb-3">
                <strong>שחקנים:</strong>
                ${players
                  .split(", ")
                  .map(
                    (player) =>
                      `<a href="https://he.wikipedia.org/wiki/${encodeURIComponent(
                        player
                      )}" target="_blank" rel="noopener noreferrer">${escapeHtml(
                        player
                      )}</a>`
                  )
                  .join(", ")}
              </p>
              ${
                imdbRating
                  ? `<p class="muted mb-3"><strong>דירוג IMDb:</strong> ${escapeHtml(
                      imdbRating,
                    )}/10</p>`
                  : ""
              }

              <p class="muted mb-3">
                <strong>במאי:</strong>
                ${stagemanager}
              </p>


              <p class="mb-4">${escapeHtml(c.summary || "")}</p>

              <div class="d-flex gap-2">
                <button id="likeBtn" class="btn ${liked ? "btn-success" : "btn-outline-primary"}" type="button" aria-label="${liked ? "הסר לייק" : "אהבתי"}">
                  ${liked ? "אהבת ❤" : "אהבתי"}
                </button>
                <button id="playBtn" class="btn btn-primary" type="button" aria-label="הפעל תוכן">
                  הפעל ▶
                </button>
              </div>
            </div>
          </div>
        `;
      }

      async function fetchWithTimeout(resource, options = {}) {
        const { timeout = 10000, ...rest } = options;
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), timeout);
        try {
          const resp = await fetch(resource, {
            ...rest,
            signal: controller.signal,
            headers: { Accept: "application/json" },
          });
          return resp;
        } finally {
          clearTimeout(id);
        }
      }

      async function load() {
        const id = getContentIdFromPath();
        const contentArea = $("#contentArea");
        const loading = $("#loading");
        const errorBox = $("#error");

        hide(contentArea);
        hide(errorBox);
        show(loading);

        try {
          const res = await fetchWithTimeout("/api/content/" + encodeURIComponent(id), {
            timeout: 12000,
          });
          if (!res.ok) throw new Error("Content fetch failed: " + res.status);
          const c = await res.json();

          contentArea.innerHTML = renderContent(c);
          hide(loading);
          show(contentArea);

          const likeBtn = $("#likeBtn");
          if (likeBtn) {
            likeBtn.addEventListener("click", async () => {
              likeBtn.disabled = true;
              try {

                c.likedByUser = !c.likedByUser;
                likeBtn.classList.remove("btn-outline-primary", "btn-success");
                likeBtn.classList.add(c.likedByUser ? "btn-success" : "btn-outline-primary");
                likeBtn.textContent = c.likedByUser ? "אהבת ❤" : "אהבתי";

                // Send the request to the server
                const r = await fetch(
                  "/content/" + encodeURIComponent(id) + (c.likedByUser ? "/like" : "/unlike"),
                  {
                    method: "POST",
                    headers: { Accept: "application/json" },
                  }
                );

                if (!r.ok) {
                  // Revert the state if the request fails
                  c.likedByUser = !c.likedByUser;
                  likeBtn.classList.remove("btn-outline-primary", "btn-success");
                  likeBtn.classList.add(c.likedByUser ? "btn-success" : "btn-outline-primary");
                  likeBtn.textContent = c.likedByUser ? "אהבת ❤" : "אהבתי";
                  alert("שגיאה בשמירת הלייק");
                }
              } catch (err) {
                console.error("like request failed", err);
                alert("שגיאה בשמירת הלייק");
                // Revert the state in case of an error
                c.likedByUser = !c.likedByUser;
                likeBtn.classList.remove("btn-outline-primary", "btn-success");
                likeBtn.classList.add(c.likedByUser ? "btn-success" : "btn-outline-primary");
                likeBtn.textContent = c.likedByUser ? "אהבת ❤" : "אהבתי";
              } finally {
                setTimeout(() => (likeBtn.disabled = false), 1500);
              }
            });
          }

          const playBtn = document.querySelector("#playBtn");
          if (playBtn) {
            playBtn.addEventListener("click", async () => {
              if (!c.videoUrl) {
                alert("לא נמצא קובץ וידאו להפעלה.");
                return;
              }
              const id = getContentIdFromPath();
              try {
                await fetch("/content/" + encodeURIComponent(id) + "/track-play", {
                  method: "POST",
                  headers: { Accept: "application/json" },
                });
              } catch (trackErr) {
                console.error("play tracking failed", trackErr);
              } finally {
                window.location.href = "/content/" + encodeURIComponent(id) + "/player";
              }
            });
          }
        } catch (err) {
          console.error(err);
          hide(loading);
          errorBox.textContent = err.message || "אירעה שגיאה";
          errorBox.classList.remove("d-none");
          errorBox.hidden = false;
        }
      }

      load();



      
      // לוגיקת נגן הוסרה מהתבנית הזאת.
    </script>

  </body>
</html>
