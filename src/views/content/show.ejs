<!doctype html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>תוכן - BurekaFlix</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/css/main.css" />
  </head>
  <body>
    <%- include("../partial/header", { activePage: "catalog" }) %>

    <main class="container my-4">
      <section class="content-card bg-white rounded shadow-sm p-3 p-md-4 mx-auto">
        <div id="loading" class="d-flex align-items-center gap-2">
          <div class="spinner-border" role="status" aria-hidden="true"></div>
          <span>טוען תוכן…</span>
        </div>

        <div id="contentArea" hidden></div>

        <div id="error" class="alert alert-danger d-none" role="alert">
          אירעה שגיאה בטעינת הדף. נסו לרענן או לחזור מאוחר יותר.
        </div>
      </section>
    </main>

    <script>
      const $ = (sel) => document.querySelector(sel);

      function getContentIdFromPath() {
        const parts = window.location.pathname.split("/").filter(Boolean);
        return parts[parts.length - 1] || "";
      }

      function escapeHtml(str = "") {
        return String(str)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function show(el) {
        el.hidden = false;
        el.classList.remove("d-none");
      }
      function hide(el) {
        el.hidden = true;
        el.classList.add("d-none");
      }

      function renderContent(c) {
        const genres = Array.isArray(c.genres) ? c.genres.join(", ") : "";
        const players = Array.isArray(c.players) ? c.players.join(", ") : "";
        const poster = c.posterUrl || "https://via.placeholder.com/320x460?text=Poster";
        const stagemanager = c.stagemanager;

        return `
          <div class="row g-4 align-items-start">
            <div class="col-12 col-md-auto">
              <img
                class="poster"
                src="${escapeHtml(poster)}"
                alt="פוסטר: ${escapeHtml(c.title || "ללא שם")}"
              />
            </div>

            <div class="col">
              <h1 class="h3 mb-2">${escapeHtml(c.title || "ללא כותרת")}</h1>
              <p class="muted mb-3">
                ${escapeHtml(c.year ?? "")}${c.year && genres ? " • " : ""}${escapeHtml(
          genres,
        )}
              </p>
              <p class="muted mb-3">
                <strong>שחקנים:</strong>
                ${players
                  .split(", ")
                  .map(
                    (player) =>
                      `<a href="https://he.wikipedia.org/wiki/${encodeURIComponent(
                        player
                      )}" target="_blank" rel="noopener noreferrer">${escapeHtml(
                        player
                      )}</a>`
                  )
                  .join(", ")}
              </p>

              <p class="muted mb-3">
                <strong>במאי:</strong>
                ${stagemanager}
              </p>


              <p class="mb-4">${escapeHtml(c.summary || "")}</p>

              <div class="d-flex gap-2">
                <button id="likeBtn" class="btn btn-outline-primary" type="button" aria-label="אהבתי">
                  אהבתי
                </button>
              </div>
            </div>
          </div>
        `;
      }

      async function fetchWithTimeout(resource, options = {}) {
        const { timeout = 10000, ...rest } = options;
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), timeout);
        try {
          const resp = await fetch(resource, {
            ...rest,
            signal: controller.signal,
            headers: { Accept: "application/json" },
          });
          return resp;
        } finally {
          clearTimeout(id);
        }
      }

      async function load() {
        const id = getContentIdFromPath();
        const contentArea = $("#contentArea");
        const loading = $("#loading");
        const errorBox = $("#error");

        hide(contentArea);
        hide(errorBox);
        show(loading);

        try {
          const res = await fetchWithTimeout("/api/content/" + encodeURIComponent(id), {
            timeout: 12000,
          });
          if (!res.ok) throw new Error("Content fetch failed: " + res.status);
          const c = await res.json();

          contentArea.innerHTML = renderContent(c);
          hide(loading);
          show(contentArea);

          const likeBtn = $("#likeBtn");
          if (likeBtn) {
            likeBtn.addEventListener("click", async () => {
              likeBtn.disabled = true;
              try {
                const r = await fetch("/content/" + encodeURIComponent(id) + "/like", {
                  method: "POST",
                  headers: { Accept: "application/json" },
                });
                if (r.ok) {
                  likeBtn.classList.remove("btn-outline-primary");
                  likeBtn.classList.add("btn-success");
                  likeBtn.textContent = "נשמר ✔";
                } else {
                  alert("שגיאה בשמירת הלייק");
                }
              } catch (err) {
                console.error("like request failed", err);
                alert("שגיאה בשמירת הלייק");
              } finally {
                setTimeout(() => (likeBtn.disabled = false), 1500);
              }
            });
          }
        } catch (err) {
          console.error(err);
          hide(loading);
          errorBox.textContent = err.message || "אירעה שגיאה";
          errorBox.classList.remove("d-none");
          errorBox.hidden = false;
        }
      }

      load();
    </script>
  </body>
</html>
