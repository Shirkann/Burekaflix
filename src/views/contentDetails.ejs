<!doctype html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>×ª×•×›×Ÿ - BurekaFlix</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/css/main.css" />
    <link rel="icon" href="/logo.png" type="image/png">
  </head>
  <body>
    <%- include("header", { activePage: "catalog" }) %>

    <main class="container my-4">
      <section
        class="content-card bg-white rounded shadow-sm p-3 p-md-4 mx-auto"
      >
        <div id="loading" class="d-flex align-items-center gap-2">
          <div class="spinner-border" role="status" aria-hidden="true"></div>
          <span>×˜×•×¢×Ÿ ×ª×•×›×Ÿâ€¦</span>
        </div>

        <div id="contentArea" hidden></div>
        <div id="similarSection" class="mt-4 d-none" hidden>
          <h5 class="mb-3">×ª×›× ×™× ×“×•××™× ×‘×–×³×× ×¨</h5>
          <!-- Horizontal scroll row for similar items -->
          <div id="similarRow" class="d-flex gap-4 overflow-auto py-2"></div>
        </div>

        <div id="error" class="alert alert-danger d-none" role="alert">
          ××™×¨×¢×” ×©×’×™××” ×‘×˜×¢×™× ×ª ×”×“×£. × ×¡×• ×œ×¨×¢× ×Ÿ ××• ×œ×—×–×•×¨ ×××•×—×¨ ×™×•×ª×¨.
        </div>
      </section>
    </main>


    <script>
      const $ = (sel) => document.querySelector(sel);

      function getContentIdFromPath() {
        const parts = window.location.pathname.split("/").filter(Boolean);
        return parts[parts.length - 1] || "";
      }

      function escapeHtml(str = "") {
        return String(str)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function show(el) {
        el.hidden = false;
        el.classList.remove("d-none");
      }
      function hide(el) {
        el.hidden = true;
        el.classList.add("d-none");
      }

  function renderContent(c) {
        const genres = Array.isArray(c.genres) ? c.genres.join(", ") : "";
        const players = Array.isArray(c.players) ? c.players.join(", ") : "";
        const poster =
          c.posterUrl || "https://via.placeholder.com/320x460?text=Poster";
        const stagemanager = c.stagemanager;
        const liked = c.likedByUser;
        console.log(c.likedByUser);
        const imdbRating =
          typeof c.imdb_rating === "number"
            ? c.imdb_rating.toFixed(1)
            : typeof c.rating === "number"
              ? c.rating.toFixed(1)
              : null;

        const typeLabel = String(c.type||'').toLowerCase()==='series' ? '×¡×“×¨×” ğŸ“º' : '×¡×¨×˜ ğŸ¬';
        const episodesCount = Array.isArray(c.episodes) ? c.episodes.length : 0;
        const wikipediaHref = (() => {
          const raw = (c.wikipedia || '').toString().trim();
          if (!raw) return null;
          if (raw.startsWith('http://') || raw.startsWith('https://')) return raw;
          return `https://he.wikipedia.org/wiki/${encodeURIComponent(raw)}`;
        })();


        return `
          <div class="row g-4 align-items-start">
            <div class="col-12 col-md-auto">
              <img
                class="poster"
                src="${escapeHtml(poster)}"
                alt="×¤×•×¡×˜×¨: ${escapeHtml(c.title || "×œ×œ× ×©×")}"
              />
            </div>

            <div class="col">
              <h1 class="h3 mb-2">${escapeHtml(c.title || "×œ×œ× ×›×•×ª×¨×ª")}</h1>
              <p class="muted mb-3">
                ${escapeHtml(c.year ?? "")}${c.year && genres ? " â€¢ " : ""}${escapeHtml(
                  genres,
                )}
              </p>
              <p class="muted mb-3">
                <strong>×¡×•×’:</strong> ${escapeHtml(typeLabel)}
                ${Array.isArray(c.episodes) && episodesCount ? ` | <strong>××¡×¤×¨ ×¤×¨×§×™× ğŸ§©:</strong> ${episodesCount}` : ''}
              
              </p>
              <p class="muted mb-3">
                <strong>×©×—×§× ×™× ğŸ­ :</strong>
                ${players
                  .split(", ")
                  .map(
                    (player) =>
                      `<a href="https://he.wikipedia.org/wiki/${encodeURIComponent(
                        player,
                      )}" target="_blank" rel="noopener noreferrer">${escapeHtml(
                        player,
                      )}</a>`,
                  )
                  .join(", ")}
              </p>
              ${
                imdbRating
                  ? `<p class="muted mb-3"><strong>×“×™×¨×•×’ â­:</strong> ${escapeHtml(
                      imdbRating,
                    )}/10</p>`
                  : ""
              }

              <p class="muted mb-3">
                <strong>×‘×××™ ğŸ¥:</strong>
                ${stagemanager}
              </p>
              


              <p class="mb-4">${escapeHtml(c.summary || "")}</p>
              <div class="d-flex align-items-center justify-content-between flex-wrap gap-3 mt-3">
                ${wikipediaHref 
                  ? `<a class="btn btn-outline-secondary btn-sm" href="${escapeHtml(wikipediaHref)}" target="_blank" rel="noopener noreferrer" title="×¤×ª×— ×•×™×§×™×¤×“×™×”">
                       ×•×™×§×™×¤×“×™×” ğŸ”—
                     </a>`
                  : '<span></span>'}
                <div class="d-flex gap-3">
                  ${String(c.type||'').toLowerCase()==='series' 
                    ? '' 
                    : `<button id="playBtn" class="btn btn-primary" type="button" aria-label="×”×¤×¢×œ ×ª×•×›×Ÿ">×”×¤×¢×œ â–¶</button>`}
                  <button id="likeBtn" class="btn ${liked ? "btn-success" : "btn-outline-primary"}" type="button" aria-label="${liked ? "×”×¡×¨ ×œ×™×™×§" : "××”×‘×ª×™"}">
                    ${liked ? "××”×‘×ª â¤" : "××”×‘×ª×™"}
                  </button>
                </div>
              </div>

              ${String(c.type||'').toLowerCase()==='series' 
                ? `<div class="mt-3">
                     <h6 class="mb-2">×¤×¨×§×™×</h6>
                     <div class="table-responsive">
                       <table class="table table-sm align-middle mb-0">
                         <thead>
                           <tr>
                             <th style="width: 40%">×¤×¨×§</th>
                             <th style="width: 35%">×”×ª×§×“××•×ª</th>
                             <th class="text-start" style="width: 25%">×¤×¢×•×œ×”</th>
                           </tr>
                         </thead>
                         <tbody id="episodesTbody"></tbody>
                       </table>
                     </div>
                   </div>`
                : ''}
            </div>
          </div>
        `;
      }

      function renderSimilar(items = []) {
        const row = document.getElementById('similarRow');
        const section = document.getElementById('similarSection');
        if (!Array.isArray(items) || items.length === 0) {
          section.classList.add('d-none');
          section.hidden = true;
          row.innerHTML = '';
          return;
        }

        // Limit to 5 items for the UI
        const slice = items.slice(0, 5);
        const cards = slice
          .map((it) => {
            const poster = it.posterUrl || 'https://via.placeholder.com/240x360?text=Poster';
            const title = escapeHtml(it.title || '');
            return `
              <div class="text-center" style="min-width:140px; max-width:160px;">
                <a href="/content/${it._id}" class="text-decoration-none d-block">
                  <div class="card h-100">
                    <img src="${escapeHtml(poster)}" class="card-img-top" style="height:210px;object-fit:cover" alt="${title}" />
                    <div class="card-body p-2">
                      <div class="small text-truncate" title="${title}">${title}</div>
                    </div>
                  </div>
                </a>
              </div>
            `;
          })
          .join('');

        row.innerHTML = cards;
        section.classList.remove('d-none');
        section.hidden = false;
      }

      async function fetchWithTimeout(resource, options = {}) {
        const { timeout = 10000, ...rest } = options;
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), timeout);
        try {
          const resp = await fetch(resource, {
            ...rest,
            signal: controller.signal,
            headers: { Accept: "application/json" },
          });
          return resp;
        } finally {
          clearTimeout(id);
        }
      }

      // Force a hard reload when user returns via browser Back/Forward cache
      (function setupHardReloadOnBack(){
        try {
          const nav = (performance && performance.getEntriesByType) ? performance.getEntriesByType('navigation') : [];
          if (nav && nav[0] && nav[0].type === 'back_forward') {
            // If we arrived here via back/forward, force a fresh load
            location.reload();
          }
        } catch(_) {}
        window.addEventListener('pageshow', (ev) => {
          // Some browsers (Safari/Firefox) restore from BFCache and mark persisted=true
          if (ev.persisted) {
            location.reload();
          }
        });
      })();

      async function load() {
        const id = getContentIdFromPath();
        const contentArea = $("#contentArea");
        const loading = $("#loading");
        const errorBox = $("#error"); 

        hide(contentArea);
        hide(errorBox);
        show(loading);

        try {
          const res = await fetchWithTimeout(
            "/api/content/" + encodeURIComponent(id),
            {
              timeout: 12000,
            },
          );
          if (!res.ok) throw new Error("Content fetch failed: " + res.status);
          const c = await res.json();

          contentArea.innerHTML = renderContent(c);
          hide(loading);
          show(contentArea);

          const likeBtn = $("#likeBtn");
          if (likeBtn) {
            likeBtn.addEventListener("click", async () => {
              likeBtn.disabled = true;
              try {
                c.likedByUser = !c.likedByUser;
                likeBtn.classList.remove("btn-outline-primary", "btn-success");
                likeBtn.classList.add(
                  c.likedByUser ? "btn-success" : "btn-outline-primary",
                );
                likeBtn.textContent = c.likedByUser ? "××”×‘×ª â¤" : "××”×‘×ª×™";

                const r = await fetch(
                  "/content/" +
                    encodeURIComponent(id) +
                    (c.likedByUser ? "/like" : "/unlike"),
                  {
                    method: "POST",
                    headers: { Accept: "application/json" },
                  },
                );

                if (!r.ok) {
                  c.likedByUser = !c.likedByUser;
                  likeBtn.classList.remove(
                    "btn-outline-primary",
                    "btn-success",
                  );
                  likeBtn.classList.add(
                    c.likedByUser ? "btn-success" : "btn-outline-primary",
                  );
                  likeBtn.textContent = c.likedByUser ? "××”×‘×ª â¤" : "××”×‘×ª×™";
                  alert("×©×’×™××” ×‘×©××™×¨×ª ×”×œ×™×™×§");
                }
              } catch (err) {
                console.error("like request failed", err);
                alert("×©×’×™××” ×‘×©××™×¨×ª ×”×œ×™×™×§");
                c.likedByUser = !c.likedByUser;
                likeBtn.classList.remove("btn-outline-primary", "btn-success");
                likeBtn.classList.add(
                  c.likedByUser ? "btn-success" : "btn-outline-primary",
                );
                likeBtn.textContent = c.likedByUser ? "××”×‘×ª â¤" : "××”×‘×ª×™";
              } finally {
                setTimeout(() => (likeBtn.disabled = false), 1500);
              }
            });
          }

          const playBtn = document.querySelector("#playBtn");
          if (playBtn) {
            playBtn.addEventListener("click", async () => {
              if (!c.videoUrl) {
                alert("×œ× × ××¦× ×§×•×‘×¥ ×•×™×“××• ×œ×”×¤×¢×œ×”.");
                return;
              }
              const id = getContentIdFromPath();
              try {
                await fetch(
                  "/content/" + encodeURIComponent(id) + "/track-play",
                  {
                    method: "POST",
                    headers: { Accept: "application/json" },
                  },
                );
              } catch (trackErr) {
                console.error("play tracking failed", trackErr);
              } finally {
                window.location.href =
                  "/content/" + encodeURIComponent(id) + "/player";
              }
            });
          }

          // If series: render episodes with resume info
          if (String(c.type||'').toLowerCase()==='series') {
            try {
              const cwRes = await fetchWithTimeout('/api/continue-watching', { timeout: 8000 });
              const cwList = cwRes.ok ? await cwRes.json() : [];
              renderEpisodesList(c, cwList);
            } catch (_e) {
              renderEpisodesList(c, []);
            }
          }

          // Load similar items by genre
          try {
            const simRes = await fetchWithTimeout(
              "/api/content/" + encodeURIComponent(id) + "/similar",
              { timeout: 10000 }
            );
            if (simRes.ok) {
              const similar = await simRes.json();
              renderSimilar(similar);
            }
          } catch (e) {
            console.warn('similar load failed', e);
          }
        } catch (err) {
          console.error(err);
          hide(loading);
          errorBox.textContent = err.message || "××™×¨×¢×” ×©×’×™××”";
          errorBox.classList.remove("d-none");
          errorBox.hidden = false;
        }
      }

function renderEpisodesList(content, cwList) {
  const tbody = document.getElementById("episodesTbody");
  if (!tbody) return;

  const episodes = Array.isArray(content.episodes) ? content.episodes : [];

  // ×× ××™×Ÿ ×¤×¨×§×™× - ××¦×™×’ ×”×•×“×¢×”
  if (!episodes.length) {
    tbody.innerHTML = `
      <tr>
        <td colspan="3" class="text-muted">××™×Ÿ ×¤×¨×§×™× ×–××™× ×™×</td>
      </tr>
    `;
    return;
  }

  // ×××¤×” ×œ×¤×™ ×©× ×§×•×‘×¥ ×›×“×™ ×œ×§×©×¨ ×”×ª×§×“××•×ª
  const byName = new Map();
  if (Array.isArray(cwList)) {
    cwList.forEach(item => {
      if (item && item.videoName) byName.set(item.videoName, item);
    });
  }

  // ×™×•×¦×¨ ×©×•×¨×” ×œ×›×œ ×¤×¨×§
  const rows = episodes.map((fileName, index) => {
    const baseName = String(fileName).split("/").pop();
    const entry = byName.get(fileName) || byName.get(baseName) || null;

    const seconds = entry?.seconds || 0;
    const duration = entry?.duration || 0;
    const percent = duration > 0 ? Math.min(100, Math.round((seconds / duration) * 100)) : null;
    const hasProgress = seconds > 0 && percent !== null;

    const progressCell = percent !== null
      ? `
        <div class="progress" style="height: 8px;">
          <div
            class="progress-bar bg-success"
            role="progressbar"
            style="width: ${percent}%"
            aria-valuenow="${percent}"
            aria-valuemin="0"
            aria-valuemax="100">
          </div>
        </div>
        <div class="small text-muted mt-1">${percent}%</div>
      `
      : `<span class="text-muted">â€“</span>`;

    const buttonLabel = hasProgress ? "×”××©×š â–¶" : "× ×’×Ÿ â–¶";
    const buttonClass = hasProgress ? "btn-success" : "btn-primary";

    return `
      <tr>
        <td class="text-truncate">×¤×¨×§ ${index + 1}</td>
        <td>${progressCell}</td>
        <td class="text-start">
          <a
            class="btn btn-sm ${buttonClass}"
            href="/content/${encodeURIComponent(content._id)}/player?ep=${index}">
            ${buttonLabel}
          </a>
        </td>
      </tr>
    `;
  }).join("");

  tbody.innerHTML = rows;
}


      load();

    </script>
  </body>
</html>
